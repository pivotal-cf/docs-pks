---
title: Backing up PKS
owner: PKS
---

<strong><%= modified_date %></strong>

This topic describes how to use BOSH Backup and Restore (BBR) to back up the  <%= vars.product_full %> BOSH Director, Control Plane and its cluster deployments.

The <%= vars.product_short %> BOSH Director, Control Plane, and cluster deployments includes custom backup and restore scripts which encapsulate the correct procedure
for backing up and restoring the Director and Control Plane.

BBR orchestrates running the backup and restore scripts and transferring the generated backup artifacts to and from a backup directory.
If configured correctly, BBR can use TLS to communicate securely with backup targets.

* To perform a restore of the BOSH Director, see [Restoring the <%= vars.product_short %> BOSH Director](bbr-restore-director.html).
* To perform a restore of the PKS Control Plane, see [Restoring the <%= vars.product_short %> Control Plane](bbr-restore-control-plane.html).
* To perform a restore of a cluster deployment, see [Restoring a Cluster](bbr-restore-cluster.html).

To view the BBR release notes, see the Cloud Foundry documentation, [BOSH Backup and Restore Release Notes](https://docs.cloudfoundry.org/bbr/bbr-rn.html).

## <a id='supported'></a> Supported Components

BBR can backup the following components:

  * BOSH Director
  * <%= vars.product_short %> control plane UAA MySQL database
  * <%= vars.product_short %> control plane PKS API MySQL database
  * The ETCD database of a cluster.

## <a id='unsupported'></a> Unsupported Components

BBR backups of the following components are not yet supported:

  * Harbor tile
  * Persistent volumes attached to nodes.
  * Network resources e.g. Load Balancers to the cluster

BBR backups of the following components have not been validated:

  * vSphere with NSX-t Objects

## <a id='prereqs'></a> Prerequisites

The following steps need to be carried out in order to perform a end-to-end backup of <%= vars.product_short %>, i.e. the BOSH Director, the Control Plane and its cluster deployments.

* [Verify your BBR Version](#verify-bbr-version)
* [Download the BBR SSH Credentials](#bbr-ssh-creds)
* [Download the BOSH Director Credentials](#bosh-creds)
* [Download the UAA Client Credentials](#cluster-creds)
* [Retrieve the BOSH Director Address](#bosh-address)
* [Download the Root CA Certificate](#root-ca-cert)
* [Download the BOSH Commandline Credentials](#bosh-cli-creds)
* [Retrieve your Cluster Deployment Name](#cluster-deployment-name)

### <a id='verify-bbr-version'></a> Verify your BBR Version

Before proceeding, you must verify that the installed version of BBR is compatible with this <%= vars.product_short %> release.
For minimum version information, see the [<%= vars.product_short %> Release Notes](release-notes.html).

To see what version of BBR you have installed, run the following command:

```
bbr version
```

If you do not have BBR installed and do not meet the minimum version requirement, see [Installing BOSH Backup and Restore](bbr-install.html).

### <a id='bbr-ssh-creds'></a> Download the BBR SSH Credentials

There are two ways to retrieve BOSH Director credentials:

* [Ops Manager Installation Dashboard](#bbr-ssh-creds-via-ui)
* [Ops Manager API](#bbr-ssh-creds-via-api)

#### <a id='bbr-ssh-creds-via-ui'></a> Ops Manager Installation Dashboard

To retrieve your **Bbr Ssh Credentials** using the Ops Manager Installation Dashboard, perform the following steps:

1. Navigate to the Ops Manager Installation Dashboard.
1. Click the BOSH Director tile.
1. Click the **Credentials** tab.

1. Locate **Bbr Ssh Credentials**.
  1. Click Link to Credentials next to it.
  1. Copy the value of the `private_key_pem` field.
  1. run the following command to reformat the copied value, and save it in the current directory to a file named `PRIVATE-KEY-FILE`:

    ```
    printf -- "YOUR-PRIVATE-KEY" > PRIVATE-KEY-FILE
    ```
    Replace the placeholder text using the information in the following table:
    <table>
      <tr>
        <th width="32%">Placeholder Text</th>
        <th>Instructions</th>
      </tr>
      <tr>
        <td><code>YOUR-PRIVATE-KEY</code></td>
        <td>This is the text of your private key.</td>
      </tr>
      <tr>
        <td><code>PRIVATE-KEY-FILE</code></td>
        <td>This is the path to the private key file you are creating.</td>
      </tr>
    </table>

    For example:
    <pre class="terminal">
    $ printf --  "-----begin rsa private key----- fake key contents ----end rsa private key-----" > bbr_key.pem
    </re>

#### <a id='bbr-ssh-creds-via-api'></a> Ops Manager API

To retrieve your **Bbr Ssh Credentials** using the Ops Manager API, perform the following steps:

1. Obtain your UAA access token. For more information, see [Access the API](https://docs.pivotal.io/pivotalcf/customizing/ops-man-api.html#access-api)
1. Retrieve the **Bbr Ssh Credentials** by running the following command:

    ```
    curl "https://OPS-MAN-FQDN/api/v0/deployed/director/credentials/bbr_ssh_credentials" \
    -X GET \
    -H "Authorization: Bearer UAA-ACCESS-TOKEN"
    ```
    Replace the placeholder text using the information in the following table:
    <table>
      <tr>
        <th width="32%">Placeholder Text</th>
        <th>Instructions</th>
      </tr>
      <tr>
        <td><code>OPS-MAN-FQDN</code></td>
        <td>This is the fully-qualified domain name (FQDN) for your Ops Manager deployment.</td>
      </tr>
      <tr>
        <td><code>UAA-ACCESS-TOKEN</code></td>
        <td>This is your UAA access token.</td>
      </tr>
    </table>

1. Copy the value of the `private_key_pem` field.
1. Run the following command to reformat the copied value, and save it in the current directory
to a file named `PRIVATE-KEY-FILE`:

    ```
    printf -- "YOUR-PRIVATE-KEY" > PRIVATE-KEY-FILE
    ```
    Replace the placeholder text using the information in the following table:
    <table>
      <tr>
        <th width="32%">Placeholder Text</th>
        <th>Instructions</th>
      </tr>
      <tr>
        <td><code>YOUR-PRIVATE-KEY</code></td>
        <td>This is the text of your private key.</td>
      </tr>
      <tr>
        <td><code>PRIVATE-KEY-FILE</code></td>
        <td>This is the path to the private key file you are creating.</td>
      </tr>
    </table>

    For example:
    <pre class="terminal">
    $ printf --  "-----begin rsa private key----- fake key contents ----end rsa private key-----" > bbr_key.pem
    </re>

### <a id='bosh-creds'></a> Download the BOSH Director Credentials

There are two ways to retrieve BOSH Director credentials:

* [Ops Manager Installation Dashboard](#bosh-creds-via-ui)
* [Ops Manager API](#bosh-creds-via-api)

#### <a id='bosh-creds-via-ui'></a> Ops Manager Installation Dashboard

To retrieve your BOSH Director credentials using the Ops Manager Installation Dashboard, perform the following steps:

1. Navigate to the Ops Manager Installation Dashboard.
1. Click the BOSH Director tile.
1. Click the **Credentials** tab.

1. Locate **Director Credentials**.
  1. Click **Link to Credentials** next to it.
  1. Copy the value of the `private_key_pem` field.
  1. Run the following command to reformat the copied value, and save it in the current directory to a file named `PRIVATE-KEY-FILE`:

    ```
    printf -- "YOUR-PRIVATE-KEY" > PRIVATE-KEY-FILE
    ```
    Replace the placeholder text using the information in the following table:
    <table>
      <tr>
        <th width="32%">Placeholder Text</th>
        <th>Instructions</th>
      </tr>
      <tr>
        <td><code>YOUR-PRIVATE-KEY</code></td>
        <td>This is the text of your private key.</td>
      </tr>
      <tr>
        <td><code>PRIVATE-KEY-FILE</code></td>
        <td>This is the path to the private key file you are creating.</td>
      </tr>
    </table>

    For example:
    <pre class="terminal">
    $ printf --  "-----begin rsa private key----- fake key contents ----end rsa private key-----" > bbr_key.pem
    </re>

#### <a id='bosh-creds-via-api'></a> Ops Manager API

To retrieve your BOSH Director credentials using the Ops Manager API, perform the following steps:

1. Obtain your UAA access token. For more information, see [Access the API](https://docs.pivotal.io/pivotalcf/customizing/ops-man-api.html#access-api)
1. Retrieve the **Director Credentials** by running the following command:

    ```
    curl "https://OPS-MAN-FQDN/api/v0/deployed/director/credentials/bbr_ssh_credentials" \
    -X GET \
    -H "Authorization: Bearer UAA-ACCESS-TOKEN"
    ```
    Replace the placeholder text using the information in the following table:
    <table>
      <tr>
        <th width="32%">Placeholder Text</th>
        <th>Instructions</th>
      </tr>
      <tr>
        <td><code>OPS-MAN-FQDN</code></td>
        <td>This is the fully-qualified domain name (FQDN) for your Ops Manager deployment.</td>
      </tr>
      <tr>
        <td><code>UAA-ACCESS-TOKEN</code></td>
        <td>This is your UAA access token.</td>
      </tr>
    </table>

1. Copy the value of the `private_key_pem` field.
1. Run the following command to reformat the copied value, and save it in the current directory
to a file named `PRIVATE-KEY-FILE`:

    ```
    printf -- "YOUR-PRIVATE-KEY" > PRIVATE-KEY-FILE
    ```
    Replace the placeholder text using the information in the following table:
    <table>
      <tr>
        <th width="32%">Placeholder Text</th>
        <th>Instructions</th>
      </tr>
      <tr>
        <td><code>YOUR-PRIVATE-KEY</code></td>
        <td>This is the text of your private key.</td>
      </tr>
      <tr>
        <td><code>PRIVATE-KEY-FILE</code></td>
        <td>This is the path to the private key file you are creating.</td>
      </tr>
    </table>

    For example:
    <pre class="terminal">
    $ printf --  "-----begin rsa private key----- fake key contents ----end rsa private key-----" > bbr_key.pem
    </re>

### <a id='cluster-creds'></a> Download the UAA Client Credentials

You must use BOSH credentials that limit the scope of BBR activity to your cluster deployments.  To obtain these credentials, perform the following steps:

  1. From the Ops Manager Installation Dashboard, click the **<%= vars.product_tile %>** tile.
  1. Select the **Credentials** tab.
  1. Navigate to **Credentials > UAA Client Credentials**.
  1. Record the value for `uaa_client_secret`.
  1. Record the value for `uaa_client_name`.

### <a id='bosh-address'></a> Retrieve the BOSH Director Address

1. If you are not using the Ops Manager VM as your jumpbox, install the latest [BOSH CLI](https://bosh.io/docs/cli-v2.html#install) on your jumpbox.
1. From the Installation Dashboard in Ops Manager, select **BOSH Director > Status** and record the IP address listed for the Director.
You access the BOSH Director using this IP address.

1. From the command line, log into the BOSH Director, using the IP address that you recorded above,
by running the following command:

    <pre>
    bosh -e BOSH-DIRECTOR-IP \
    --ca-cert PATH-TO-BOSH-SERVER-CERTIFICATE log-in
    </pre>

    Replace the placeholder text using the information in the following table.
    <table>
      <tr>
        <th width="32%">Placeholder Text</th>
        <th>Instructions</th>
      </tr>
      <tr>
        <td><code>BOSH-DIRECTOR-IP</code></td>
        <td>This is the BOSH Director IP address recorded above.</td>
      </tr>
      <tr>
        <td><code>PATH-TO-BOSH-SERVER-CERTIFICATE</code></td>
        <td>This is the path to the root Certificate Authority (CA) certificate as outlined in [Download the Root CA Certificate](#root-ca-cert).</td>
      </tr>
    </table>

1. When prompted for **Email ()**, specify `director`.
1. When prompted for **Password ()**, enter the **Director Credentials** that you obtained in
   [Download the BOSH Director Credentials](#bosh-creds).

     <br>

     For example:
     <pre class='terminal'>
     $ bosh -e 10.0.0.3 \
     --ca-cert /var/tempest/workspaces/default/root\_ca\_certificate log-in
     Email (): director
     Password (): *******************
     Successfully authenticated with UAA
     Succeeded
     </pre>

### <a id='root-ca-cert'></a> Download the Root CA Certificate
To download
the root CA certificate for your <%= vars.product_short %> deployment, perform the following steps:

1. On the Ops Manager Installation Dashboard, in the top right corner, click your username.
1. Navigate to **Settings** > **Advanced**.
1. Click **Download Root CA Cert**.

### <a id='bosh-cli-creds'></a> Download the BOSH Commandline Credentials

1. On the Ops Manager Installation Dashboard, click the **BOSH Director** tile.
1. In the BOSH Director tile, click the **Credentials** tab.
1. Navigate to **Bosh Command line Credentials** and click **Link to Credential**.
1. Copy the credential value.

### <a id='cluster-deployment-name'></a> Retrieve your Cluster Deployment Name

Locate and record your cluster BOSH deployment name by following the steps below.

1. <%= partial 'login-pks-api' %>

1. To find the cluster ID associated with the cluster you want to back up, run the following
command:

    ```
    pks cluster CLUSTER-NAME
    ```
    Where `CLUSTER-NAME` is the name of your cluster. From the output of this command, record the
    value of **UUID**.

1. From the Ops Manager Installation Dashboard, click the **BOSH Director** tile.

1. Select the **Credentials** tab.

1. Navigate to **Bosh Commandline Credentials** and click **Link to Credential**.

1. Copy the credential value.

1. SSH into your jumpbox. For more information about the jumpbox, see [Installing BOSH Backup and Restore](bbr-install.html#jumpbox-setup).

1. To retrieve your cluster BOSH deployment name, run the following command:

    ```
    BOSH-CLI-CREDENTIALS deployments | grep UUID
    ```
    Replace the placeholder values as follows:
    <table>
      <tr>
        <th width="32%">Credential</th>
        <th>Location</th>
      </tr>
      <tr>
        <td><code>BOSH-CLI-CREDENTIALS</code></td>
        <td>This includes the full value that you copied from the BOSH Director tile in [Download the BOSH Commandline Credentials](bbr-backup-control-plane.html#bosh-cli-creds).</td>
      </tr>
      <tr>
        <td><code>UUID</code></td>
        <td>This is the cluster UUID that you recorded in the previous step</td>
      </tr>
    </table>

## <a id='connect-to-jumpbox'></a> Connect to Your Jumpbox

You can establish a connection to your jumpbox in one of the following ways.

* [Connect with SSH](#ssh)
* [Connect with BOSH&#95;ALL&#95;PROXY](#bosh-all-proxy)

For general information about the jumpbox, see [Installing BOSH Backup and Restore](bbr-install.html).

### <a id='ssh'></a> Connect with SSH

SSH into your jumpbox. If you connect to your jumpbox with SSH, you must run the BBR commands in
the following sections from within your jumpbox.

### <a id='bosh-all-proxy'></a> Connect with BOSH&#95;ALL&#95;PROXY

Set and use `BOSH_ALL_PROXY`. Using `BOSH_ALL_PROXY` opens an SSH tunnel with SOCKS5 to the
jumpbox. This tunnel enables you to forward requests to the BOSH Director through the jumpbox from
your local machine.

  1. To establish the tunnel and make it available on a local port, run the following command:

    ```
    ssh -4 -D 12345 -fNC jumpbox@jumpbox-ip -i jumpbox.key -o ServerAliveInterval=60
    ```

  1. To provide the BOSH CLI with access to the tunnel through use of the `BOSH_ALL_PROXY`
  environment variable, run the following command:

    ```
    export BOSH_ALL_PROXY=socks5://localhost:12345
    ```

<p class="note"><strong>Note</strong>: Using <code>BOSH_ALL_PROXY</code> can result in longer
backup and restore times due to network performance degradation. Because all operations must pass
through the proxy, moving backup artifacts can be significantly slower.</p>

## <a id='export-opsman-settings'></a> Export Installation Settings

Pivotal recommends that you back up your Ops Manager installation settings by exporting frequently.

When exporting your installation settings, keep in mind the following:

* This option is only available after you have deployed at least once.

* Always export your installation settings before following the steps in the [Recreate the BOSH Director VM](bbr-restore-director.html#recreate-vms) section of the *Backing Up and Restoring <%= vars.product_short %>* topic.

* Exporting your installation settings only backs up the settings you configured in Ops Manager. It does not back up your VMs or any external MySQL databases.

* Your Ops Manager settings are encrypted. Make sure you keep track of your Decryption Passphrase because this is needed to restore the Ops Manager settings.

There are two ways to export Ops Manager installation settings:

* [Use the Ops Manager UI](#export-via-ui)
* [Use the Ops Manager API](#export-via-api)

#### <a id='export-via-ui'></a> Use The Ops Manager UI

1. From the **Installation Dashboard** in the Ops Manager interface, click your username at the top right navigation.
1. Select **Settings**.
1. Select **Export Installation Settings**.
1. Click **Export Installation Settings**.

#### <a id='export-via-api'></a> Use The Ops Manager API
If you want to automate the back up process, you can use the Ops Manager API to export your installation settings.

  1. To export your installation settings using the Ops Manager API, run the following command:

  ```
  curl https://OPS-MAN-FQDN/api/v0/installation_asset_collection \
  -H "Authorization: Bearer UAA-ACCESS-TOKEN" > installation.zip
  ```
  Replace the placeholder text using the information in the following table.
  <table>
    <tr>
      <th width="32%">Placeholder Text</th>
      <th>Instructions</th>
    </tr>
    <tr>
      <td><code>OPS-MAN-FQDN</code></td>
      <td>This is the fully-qualified domain name (FQDN) for your Ops Manager deployment.</td>
    </tr>
    <tr>
      <td><code>UAA-ACCESS-TOKEN</code></td>
      <td>This is your UAA access token. For more information, see Access the API.</td>
    </tr>
  </table>

## <a id='back-up-director'></a> Back up the <%= vars.product_short %> BOSH Director

1. Run the BBR pre-backup check to confirm that your BOSH Director is reachable and has the correct BBR scripts:

    ```
    bbr director \
    --host BOSH-DIRECTOR-IP \
    --username bbr \
    --private-key-path PRIVATE-KEY-FILE \
    pre-backup-check
    ```
    Replace the placeholder text using the information in the following table.
    <table>
      <tr>
        <th width="32%">Placeholder Text</th>
        <th>Instructions</th>
      </tr>
      <tr>
        <td><code>BOSH-DIRECTOR-IP</code></td>
        <td>This is the address of the BOSH Director. If the BOSH Director is public, `BOSH-DIRECTOR-IP` is a URL, such as `https://my-bosh.xxx.cf-app.com`. Otherwise, this is the internal IP `BOSH-DIRECTOR-IP` which you can retrieve as show in [Retrieve the BOSH Director Address](#bosh-address).</td>
      </tr>
      <tr>
        <td><code>PRIVATE-KEY-FILE</code></td>
        <td>This is the path to the private key file that you can create from `Bbr Ssh Credentials` as shown in [Download the BBR SSH Credentials](#bbr-ssh-creds).</td>
      </tr>
    </table>

    For example:

    <pre class="terminal">
    $ bbr director \
    --host 10.0.0.5 \
    --username bbr \
    --private-key-path private-key.pem \
    pre-backup-check
    </pre>

1. If the pre-backup check command fails, perform the following actions:
    * Run the command again, adding the `--debug` flag to enable debug logs. For more information,
    see [BBR Logging](bbr-logging.html).
    * Make any correction suggested in the output and run the pre-backup check again. For example,
     the connection to the BOSH Director failed.

1. If the pre-backup check succeeds, run the BBR backup command from your jumpbox to back up the
PKS BOSH Director:

    ```
    bbr director \
    --host BOSH-DIRECTOR-IP \
    --username bbr \
    --private-key-path PRIVATE-KEY-FILE \
    backup
    ```

    Replace the placeholder text using the information in the following table.
    <table>
      <tr>
        <th width="32%">Placeholder Text</th>
        <th>Instructions</th>
      </tr>
      <tr>
        <td><code>BOSH-DIRECTOR-IP</code></td>
        <td>This is the address of the BOSH Director. If the BOSH Director is public, `BOSH-DIRECTOR-IP` is a URL, such as `https://my-bosh.xxx.cf-app.com`. Otherwise, this is the internal IP `BOSH-DIRECTOR-IP` which you can retrieve as show in [Retrieve the BOSH Director Address](#bosh-address).</td>
      </tr>
      <tr>
        <td><code>PRIVATE-KEY-FILE</code></td>
        <td>This is the path to the private key file that you can create from `Bbr Ssh Credentials` as shown in [Download the BBR SSH Credentials](#bbr-ssh-creds).</td>
      </tr>
    </table>

    For example:

    <pre class="terminal">
    $ bbr director \
    --host 10.0.0.5 \
    --username bbr \
    --private-key-path private-key.pem \
    backup
    </pre>

    <p class="note"><strong>Note</strong>: The BBR backup command can take a long time to complete.
    You can run it independently of the SSH session so that the process can continue running even
    if your connection to the jumpbox fails. The command above uses <code>nohup</code>, but you can
    run the command in a <code>screen</code> or <code>tmux</code> session instead.</p>

1. If the command completes successfully, follow the steps in [Manage Your Backup Artifact](#good-practices) below.

1. If the backup command fails, perform the following actions:
    * Run the command again, adding the `--debug` flag to enable debug logs. For more information,
    see [BBR Logging](bbr-logging.html).
    * Follow the steps in [Recover from a Failing Command](#recover-from-failing-command).

## <a id='locate-deploy-name'></a> Locate the <%= vars.product_short %> Deployment Name

Locate and record your <%= vars.product_short %> BOSH deployment name as follows:

1. Open an SSH connection to either your jumpbox, as described in the previous section, or the Ops Manager VM.
For instructions on how to SSH into the Ops Manager VM, see [Advanced Troubleshooting with the BOSH CLI](https://docs.pivotal.io/pivotalcf/customizing/trouble-advanced.html#ssh).
1. On the command line, run the following command to retrieve your <%= vars.product_short %> BOSH deployment name.

    ```
    BOSH-CLI-CREDENTIALS deployments | grep pivotal-container-service
    ```

    Where `BOSH-CLI-CREDENTIALS` includes the full value that you copied from the BOSH Director tile in [Download the BOSH Commandline Credentials
](#bosh-cli-creds).
    For example:

    <pre class="terminal">
    $ BOSH_CLIENT=ops_manager BOSH_CLIENT_SECRET=p455w0rd BOSH_CA_CERT=/var/tempest/workspaces/default/root_ca_certificate BOSH_ENVIRONMENT=10.0.0.5 bosh deployments | grep pivotal-container-service

    pivotal-container-service-51f08f6402aaa960f041           backup-and-restore-sdk/1.8.0    bosh-google-kvm-ubuntu-xenial-go_agent/250.25
    service-instance_4ffeb5b5-5182-4faa-9d92-696d97cc9ae1    bosh-dns/1.10.0                 bosh-google-kvm-ubuntu-xenial-go_agent/250.25
    pivotal-container-service-51f08f6402aaa960f041
    </pre>

1. In the output, look for the <%= vars.product_short %> BOSH deployment name that begins with
  `pivotal-container-service` and includes a unique identifier.
   In the example output above, the BOSH deployment name is `pivotal-container-service-51f08f6402aaa960f041`.

## <a id='back-up-control-plane'></a> Back up the <%= vars.product_short %> Control Plane

1. Run the BBR pre-backup check to confirm that your BOSH Director is reachable and has a
deployment that can be backed up:

    ```
    BOSH_CLIENT_SECRET=BOSH-CLIENT-SECRET \
    bbr deployment \
    --target BOSH-TARGET \
    --username BOSH-CLIENT \
    --deployment DEPLOYMENT-NAME \
    --ca-cert PATH-TO-BOSH-SERVER-CERT \
    pre-backup-check
    ```
    Replace the placeholder text using the information in the following table.
    <table>
      <tr>
        <th width="32%">Placeholder Text</th>
        <th>Instructions</th>
      </tr>
      <tr>
        <td><code>BOSH-CLIENT-SECRET</code></td>
        <td>In your BOSH Director tile, navigate to <strong>Credentials > Bosh Commandline Credentials</strong>. Record the value for <code>BOSH&#95;CLIENT&#95;SECRET</code>.</td>
      </tr>
      <tr>
        <td><code>BOSH-TARGET</code></td>
        <td>In your BOSH Director tile, navigate to <strong>Credentials > Bosh Commandline Credentials</strong>. Record the value for <code>BOSH&#95;ENVIRONMENT</code>.
        You must be able to reach the target address from the workstation where you run <code>bbr</code> commands.</td>
      </tr>
      <tr>
        <td><code>BOSH-CLIENT</code></td>
        <td>In your BOSH Director tile, navigate to <strong>Credentials > Bosh Commandline Credentials</strong>. Record the value for <code>BOSH&#95;CLIENT</code>.</td>
      </tr>
      <tr>
        <td><code>DEPLOYMENT-NAME</code></td>
        <td>Use the <%= vars.product_short %> BOSH deployment name that you located in the [Locate the <%= vars.product_short %> Deployment Names](#locate-deploy-name) section above.</td>
      </tr>
      <tr>
        <td><code>PATH-TO-BOSH-CA-CERT</code></td>
        <td>Use the path to the root CA certificate that you downloaded in [Download the Root CA Certificate](#root-ca-cert).</td>
      </tr>
    </table>
    <br>
    For example:

    <pre class="terminal">
    $ BOSH_CLIENT_SECRET=p455w0rd \
    bbr deployment \
    --target bosh.example.com \
    --username admin \
    --deployment cf-acceptance-0 \
    --ca-cert bosh.ca.cert \
    pre-backup-check</pre>

1. If the pre-backup check command fails, perform the following actions:
    * Run the command again, adding the `--debug` flag to enable debug logs. For more information,
    see [BBR Logging](bbr-logging.html).
    * Make any correction suggested in the output and run the pre-backup check again. For example,
    the deployment that you selected might not have the correct backup scripts, or the connection
    to the BOSH Director failed.

1. If the pre-backup check succeeds, run the BBR backup command from your jumpbox to back up the
PKS control plane:

    ```
    BOSH_CLIENT_SECRET=BOSH-CLIENT-SECRET \
    nohup bbr deployment \
    --target BOSH-TARGET \
    --username BOSH-CLIENT \
    --deployment DEPLOYMENT-NAME \
    --ca-cert PATH-TO-BOSH-SERVER-CERT \
    backup [--with-manifest] [--artifact-path]
    ```

    Replace the placeholder text using the information in the following table. These are the same
    values as shown in the previous table.
    <table>
      <tr>
        <th width="32%">Placeholder Text</th>
        <th>Instructions</th>
      </tr>
      <tr>
        <td><code>BOSH-CLIENT-SECRET</code></td>
        <td>In your BOSH Director tile, navigate to <strong>Credentials > Bosh Commandline Credentials</strong>. Record the value for <code>BOSH&#95;CLIENT&#95;SECRET</code>.</td>
      </tr>
      <tr>
        <td><code>BOSH-TARGET</code></td>
        <td>In your BOSH Director tile, navigate to <strong>Credentials > Bosh Commandline Credentials</strong>. Record the value for <code>BOSH&#95;ENVIRONMENT</code>.
        You must be able to reach the target address from the workstation where you run <code>bbr</code> commands.</td>
      </tr>
      <tr>
        <td><code>BOSH-CLIENT</code></td>
        <td>In your BOSH Director tile, navigate to <strong>Credentials > Bosh Commandline Credentials</strong>. Record the value for <code>BOSH&#95;CLIENT</code>.</td>
      </tr>
      <tr>
        <td><code>DEPLOYMENT-NAME</code></td>
        <td>Use the <%= vars.product_short %> BOSH deployment name that you located in the [Locate the <%= vars.product_short %> Deployment Names](#locate-deploy-name) section above.</td>
      </tr>
      <tr>
        <td><code>PATH-TO-BOSH-CA-CERT</code></td>
        <td>Use the path to the root CA certificate that you downloaded in [Download the Root CA Certificate](#root-ca-cert).</td>
      </tr>
    </table>
    <br>
    Specify optional flags for the `backup` command:
      <table>
        <tr>
          <th width="32%">Flag</th>
          <th>Description</th>
        </tr>
        <tr>
          <td><code>--with-manifest</code></td>
          <td>This includes the manifest in the backup artifact. If you use this flag, the backup artifact then contains credentials that you should keep secret.</td>
        </tr>
        <tr>
          <td><code>--artifact-path</code></td>
          <td>This allows you to specify a path for the backup artifact.</td>
        </tr>
      </table>
      <br>

      <p class="note"><strong>Note</strong>: The `--with-manifest` flag is necessary in order to redeploy your PKS Control Plane in the case of its loss.</p>

      For example:

    <pre class="terminal">
    $ BOSH_CLIENT_SECRET=p455w0rd \
    nohup bbr deployment \
    --target bosh.example.com \
    --username admin \
    --deployment cf-acceptance-0 \
    --ca-cert bosh.ca.cert \
    backup --with-manifest
    </pre>

    <p class="note"><strong>Note</strong>: The BBR backup command can take a long time to complete.
    You can run it independently of the SSH session so that the process can continue running even
    if your connection to the jumpbox fails. The command above uses <code>nohup</code>, but you can
    run the command in a <code>screen</code> or <code>tmux</code> session instead.</p>

1. If the command completes successfully, follow the steps in [Manage Your Backup Artifact](#good-practices) below.

1. If the backup command fails, perform the following actions:
    * Run the command again, adding the `--debug` flag to enable debug logs. For more information,
    see [BBR Logging](bbr-logging.html).
    * Follow the steps in [Recover from a Failing Command](#recover-from-failing-command).

## <a id='verify-deployments'></a> Verify your Cluster Deployments

To verify that you can reach your PKS cluster deployments and that can be backed up, follow the steps below.

  1. SSH into your jumpbox. For more information about the jumpbox, see [Installing BOSH Backup and Restore](bbr-install.html#jumpbox-setup).
  1. To perform the BBR pre-backup check, run the following command from your jumpbox:

      ```
      BOSH_CLIENT_SECRET=PKS-UAA-CLIENT-SECRET \
      bbr deployment \
      --all-deployments \
      --target BOSH-TARGET \
      --username PKS-UAA-CLIENT-NAME \
      --ca-cert PATH-TO-BOSH-SERVER-CERT \
      pre-backup-check
      ```

      Replace the placeholder text using the information in the following table.
      <table>
        <tr>
          <th width="32%">Placeholder Text</th>
          <th>Instructions</th>
        </tr>
        <tr>
          <td><code>PKS-UAA-CLIENT-SECRET</code></td>
          <td>Enter the value you recorded for `uaa_client_secret` in [Download the UAA Client Credentials](#cluster-creds).</td>
        </tr>
        <tr>
          <td><code>BOSH-TARGET</code></td>
          <td>Enter the value you recorded for the BOSH Director's address in [Retrieve the BOSH Director Address](#bosh-address).
              You must be able to reach the target address from the machine where you run `bbr` commands.</td>
        </tr>
        <tr>
          <td><code>PKS-UAA-CLIENT-NAME</code></td>
          <td>Enter the value you recorded for `uaa_client_name` in [Download the UAA Client Credentials](#cluster-creds).</td>
        </tr>
        <tr>
          <td><code>PATH-TO-BOSH-SERVER-CERT</code></td>
          <td>Use the path to the root CA certificate that you downloaded in [Download or Locate Root CA Certificate](#root-ca-cert).</td>
        </tr>
      </table>
      <br>

      For example:
      <pre class="terminal">
      $ BOSH\_CLIENT\_SECRET=p455w0rd \
      bbr deployment \
      --all-deployments \
      --target bosh.example.com \
      --username pivotal-container-service-12345abcdefghijklmn \
      --ca-cert /var/tempest/workspaces/default/root\_ca\_certificate \
      pre-backup-check
      </pre>

  1. If the pre-backup-check command is successful, the command returns a list of cluster
     deployments that can be backed up.

     <br>

     For example:
     <pre class="terminal">
     [21:51:23] Pending: service-instance\_abcdeg-1234-5678-hijk-90101112131415
     [21:51:23] -------------------------
     [21:51:31] Deployment 'service-instance\_abcdeg-1234-5678-hijk-90101112131415' can be backed up.
     [21:51:31] -------------------------
     [21:51:31] Successfully can be backed up: service-instance\_abcdeg-1234-5678-hijk-90101112131415
     </pre>

     In the output above, `service-instance_abcdeg-1234-5678-hijk-90101112131415` is the
     BOSH deployment name of a PKS cluster.

  1. If the pre-backup-check command fails, do one or more of the following:
      * Make sure you are using the correct <%= vars.product_tile %> credentials.
      * Run the command again, adding the `--debug` flag to enable debug logs. For more information,
        see [Exit Codes and Logging](bbr-logging.html).
      * Make the changes suggested in the output and run the pre-backup check again. For example,
        the deployments might not have the correct backup scripts, or the connection to
        the BOSH Director failed.

## <a id='back-up-clusters'></a> Back up Clusters

When backing up your PKS cluster, you can choose to back up only one cluster or to backup all cluster deployments in scope.
The procedures to do this are the following:

* [Back up all Cluster Deployments](#back-up-all)
* [Back up one Cluster Deployment](#back-up-one)

### <a id='back-up-all'></a> Back up all Cluster Deployments

The following procedure backs up all cluster deployments.

Make sure you use the PKS UAA credentials that you recorded in
[Download the UAA Client Credentials](#cluster-creds).
These credentials limit the scope of the backup to cluster deployments only.


  1. To back up all cluster deployments, run the following command from your jumpbox:

      ```
      BOSH_CLIENT_SECRET=PKS-UAA-CLIENT-SECRET \
      nohup bbr deployment \
      --all-deployments \
      --target BOSH-DIRECTOR-IP \
      --username PKS-UAA-CLIENT-NAME \
      --ca-cert PATH-TO-BOSH-SERVER-CERT \
      backup [--with-manifest] [--artifact-path]
      ```

      Replace the placeholder text using the information in the following table.
      <table>
        <tr>
          <th width="32%">Placeholder Text</th>
          <th>Instructions</th>
        </tr>
        <tr>
          <td><code>PKS-UAA-CLIENT-SECRET</code></td>
          <td>Enter the value you recorded for `uaa_client_secret` in [Download the UAA Client Credentials](#cluster-creds).</td>
        </tr>
        <tr>
          <td><code>BOSH-TARGET</code></td>
          <td>Enter the value you recorded for the BOSH Director's address in [Retrieve the BOSH Director Address](#bosh-address).
              You must be able to reach the target address from the machine where you run `bbr` commands.</td>
        </tr>
        <tr>
          <td><code>PKS-UAA-CLIENT-NAME</code></td>
          <td>Enter the value you recorded for `uaa_client_name` in [Download the UAA Client Credentials](#cluster-creds).</td>
        </tr>
        <tr>
          <td><code>PATH-TO-BOSH-SERVER-CERT</code></td>
          <td>Use the path to the root CA certificate that you downloaded in [Download or Locate Root CA Certificate](#root-ca-cert).</td>
        </tr>
      </table>
      <br>

      Specify optional flags for the `backup` subcommand:
      <table>
        <tr>
          <th width="32%">Flag</th>
          <th>Description</th>
        </tr>
        <tr>
          <td><code>--with-manifest</code></td>
          <td>This includes the manifest in the backup artifact. If you use this flag, the backup artifact then contains credentials that you should keep secret.</td>
        </tr>
        <tr>
          <td><code>--artifact-path</code></td>
          <td>This allows you to specify a path for the backup artifact.</td>
        </tr>
      </table>
      <br>

      For example:
      <pre class="terminal">
      $ BOSH\_CLIENT\_SECRET=p455w0rd \
      nohup bbr deployment \
      --all-deployments \
      --target bosh.example.com \
      --username pivotal-container-service-12345abcdefghijklmn \
      --ca-cert /var/tempest/workspaces/default/root\_ca\_certificate \
      backup
      </pre>

      <p class="note"><strong>Note</strong>: The BBR backup command can take a long time to complete. You can run it independently of the SSH session so that the process can continue running even if your connection to the jumpbox fails. The command above uses <code>nohup</code>, but you could also run the command in a <code>screen</code> or <code>tmux</code> session.</p>

  1. If the `backup` command completes successfully, follow the steps in [Manage Your Backup Artifact](#good-practices) below.

  1. If the backup command fails, the backup operation exits. BBR does not attempt to continue backing up any non-backed up clusters.
  To troubleshoot a failing backup, do one or more of the following:
      * Run the command again, adding the `--debug` flag to enable debug logs. For more information,
        see [Exit Codes and Logging](bbr-logging.html).
      * Follow the steps in [Recover from a Failing Command](#recovering-from-failing-command).

### <a id='back-up-one'></a> Back up One Cluster Deployment

  1. To backup a single, specific cluster deployment, run the following command from your jumpbox:

      ```
      BOSH_CLIENT_SECRET=PKS-UAA-CLIENT-SECRET \
      nohup bbr deployment \
      --deployment CLUSTER-DEPLOYMENT-NAME \
      --target BOSH-DIRECTOR-IP \
      --username PKS-UAA-CLIENT-NAME \
      --ca-cert PATH-TO-BOSH-SERVER-CERT \
      backup [--with-manifest] [--artifact-path]
      ```

      Replace the placeholder text using the information in the following table.
      <table>
        <tr>
          <th width="32%">Placeholder Text</th>
          <th>Instructions</th>
        </tr>
        <tr>
          <td><code>PKS-UAA-CLIENT-SECRET</code></td>
          <td>Enter the value you recorded for `uaa_client_secret` in [Download the UAA Client Credentials](#cluster-creds).</td>
        </tr>
        <tr>
          <td><code>CLUSTER-DEPLOYMENT-NAME </code></td>
          <td>Enter the value you recorded for in [Retrieve your Cluster Deployment Name](#cluster-deployment-name).</td>
        </tr>
        <tr>
          <td><code>BOSH-TARGET</code></td>
          <td>Enter the value you recorded for the BOSH Director's address in [Retrieve the BOSH Director Address](#bosh-address).
              You must be able to reach the target address from the machine where you run `bbr` commands.</td>
        </tr>
        <tr>
          <td><code>PKS-UAA-CLIENT-NAME</code></td>
          <td>Enter the value you recorded for `uaa_client_name` in [Download the UAA Client Credentials](#cluster-creds).</td>
        </tr>
        <tr>
          <td><code>PATH-TO-BOSH-SERVER-CERT</code></td>
          <td>Use the path to the root CA certificate that you downloaded in [Download or Locate Root CA Certificate](#root-ca-cert).</td>
        </tr>
      </table>
      <br>

      Specify optional flags for the `backup` subcommand:
      <table>
        <tr>
          <th width="32%">Flag</th>
          <th>Description</th>
        </tr>
        <tr>
          <td><code>--with-manifest</code></td>
          <td>This includes the manifest in the backup artifact. If you use this flag, the backup artifact then contains credentials that you should keep secret.</td>
        </tr>
        <tr>
          <td><code>--artifact-path</code></td>
          <td>This allows you to specify a path for the backup artifact.</td>
        </tr>
      </table>
      <br>

      For example:
      <pre class="terminal">
      $ BOSH\_CLIENT\_SECRET=p455w0rd \
      nohup bbr deployment \
      --deployment service-instance\_abcdeg-1234-5678-hijk-9010111213141 \
      --target bosh.example.com \
      --username pivotal-container-service-12345abcdefghijklmn \
      --ca-cert /var/tempest/workspaces/default/root\_ca\_certificate \
      backup
      </pre>

  1. If the `backup` command completes successfully, follow the steps in [Manage Your Backup Artifact](#good-practices) below.

  1. If the backup command fails, do one or more of the following:
      * Run the command again, adding the `--debug` flag to enable debug logs. For more information,
        see [Exit Codes and Logging](bbr-logging.html).
      * Follow the steps in [Recover from a Failing Command](#recovering-from-failing-command).

## <a id="recover-from-failing-command"></a> Recover from a Failing Command

If the backup fails, follow these steps:

1. Ensure that you set all the parameters in the backup command.
1. Ensure the credentials previously obtained are valid.
1. Ensure the deployment that you specify in the BBR command exists.
1. Ensure that the jumpbox can reach the BOSH Director.
1. Consult [BBR Logging](bbr-logging.html).
1. If you see the error message `Directory /var/vcap/store/bbr-backup already exists on instance`,
   run the appropriate cleanup command. See [Clean up After a Failed Backup](#manual-clean) below.
1. If the backup artifact is corrupted, discard the failing artifacts and run the backup again.

## <a id='cancel-backup'></a> Cancel a Backup

Backups can take a long time.
If you need to cancel a backup, for example if you realize that the backup is going to fail or that
your developers need to push an app in a hurry, follow these steps:

1. Terminate the BBR process by pressing Ctrl-C and typing `yes` to confirm.
1. Because stopping a backup can leave the system in an unusable state and prevent additional
backups, follow the procedures in [Clean up After a Failed Backup](#manual-clean) below.

## <a id="manual-clean"></a> Clean up After a Failed Backup

If your backup process fails, it might leave the BBR backup directory on the instance, causing any
subsequent attempts to backup to fail.
In addition, BBR might not have run the post-backup scripts, leaving the instance in a locked state.

  * If the PKS BOSH Director backup failed, run the following command to use the BBR cleanup script to
    clean up:

      ```
      bbr director \
      --host BOSH-DIRECTOR-IP \
      --username bbr \
      --private-key-path PRIVATE-KEY-FILE \
      backup-cleanup
      ```

      Replace the placeholder text using the information in the following table.
      <table>
        <tr>
          <th width="32%">Placeholder Text</th>
          <th>Instructions</th>
        </tr>
        <tr>
          <td><code>BOSH-DIRECTOR-IP</code></td>
          <td>This is the address of the BOSH Director. If the BOSH Director is public, `BOSH-DIRECTOR-IP` is a URL, such as `https://my-bosh.xxx.cf-app.com`. Otherwise, this is the internal IP `BOSH-DIRECTOR-IP` which you can retrieve as show in [Retrieve the BOSH Director Address](#bosh-address).</td>
        </tr>
        <tr>
          <td><code>PRIVATE-KEY-FILE</code></td>
          <td>This is the path to the private key file that you can create from `Bbr Ssh Credentials` as shown in [Download the BBR SSH Credentials](#bbr-ssh-creds).</td>
        </tr>
      </table>
      <br>

      For example:

      <pre class="terminal">
      $ bbr director \
      --host 10.0.0.5 \
      --username bbr \
      --private-key-path private-key.pem \
      backup-cleanup
      </pre>

  * If the PKS control plane or PKS clusters backups fail, run the following command to use the BBR cleanup script to
    clean up:

    ```
    BOSH_CLIENT_SECRET=BOSH-CLIENT-SECRET \
    bbr deployment \
    --target BOSH-TARGET \
    --username BOSH-CLIENT \
    --deployment DEPLOYMENT-NAME \
    --ca-cert PATH-TO-BOSH-CA-CERT \
    backup-cleanup
    ```

    Replace the placeholder text using the information in the following table. These are the same
    values as shown in the previous table.
    <table>
      <tr>
        <th width="32%">Placeholder Text</th>
        <th>Instructions</th>
      </tr>
      <tr>
        <td><code>BOSH-CLIENT-SECRET</code></td>
        <td>In your BOSH Director tile, navigate to <strong>Credentials > Bosh Commandline Credentials</strong>. Record the value for <code>BOSH&#95;CLIENT&#95;SECRET</code>.</td>
      </tr>
      <tr>
        <td><code>BOSH-TARGET</code></td>
        <td>In your BOSH Director tile, navigate to <strong>Credentials > Bosh Commandline Credentials</strong>. Record the value for <code>BOSH&#95;ENVIRONMENT</code>.
        You must be able to reach the target address from the workstation where you run <code>bbr</code> commands.</td>
      </tr>
      <tr>
        <td><code>BOSH-CLIENT</code></td>
        <td>In your BOSH Director tile, navigate to <strong>Credentials > Bosh Commandline Credentials</strong>. Record the value for <code>BOSH&#95;CLIENT</code>.</td>
      </tr>
      <tr>
        <td><code>DEPLOYMENT-NAME</code></td>
        <td>Use the <%= vars.product_short %> BOSH deployment name that you located in the [Locate the <%= vars.product_short %> Deployment Names](#locate-deploy-name) or the name of a cluster deployment.</td>
      </tr>
      <tr>
        <td><code>PATH-TO-BOSH-CA-CERT</code></td>
        <td>Use the path to the root CA certificate that you downloaded in the [Download the Root CA Certificate](#root-ca-cert).</td>
      </tr>
    </table>

    <br>

    For example:

    <pre class="terminal">
    $ BOSH_CLIENT_SECRET=p455w0rd \
    bbr deployment \
    --target bosh.example.com \
    --username admin \
    --deployment cf-acceptance-0 \
    --ca-cert bosh.ca.crt \
    backup-cleanup
    </pre>

If the cleanup script fails, consult the following table to match the exit codes to an error
message.

<table>
  <tr>
    <th>Value</th>
    <th>Error</th>
  </tr>
  <tr>
    <td>0</td>
    <td>Success</td>
  </tr>
  <tr>
    <td>1</td>
    <td>General failure</td>
  </tr>
  <tr>
    <td>8</td>
    <td>The post-backup unlock failed. One of your deployments might be in a bad state and require
      attention.</td>
  </tr>
  <tr>
    <td>16</td>
    <td>The cleanup failed. This is a non-fatal error indicating that the utility has been unable
      to clean up open BOSH SSH connections to a deployment's VMs. Manual cleanup might be required
      to clear any hanging BOSH users and connections.</td>
  </tr>
</table>

## <a id="good-practices"></a> Manage Your Backup Artifact

Keep your backup artifacts safe by following these steps:

1. Move the backup artifacts off the jumpbox to your storage space. BBR stores each backup in a subdirectory named `DEPLOYMENT-TIMESTAMP`, for the Control Plane and cluster deployment backups, and `DIRECTOR-IP-TIMESTAMP`,
for the BOSH Director backups, within the current working directory.
The backup created by BBR consists of a directory with the backup artifacts and metadata files.

1. Compress and encrypt the backup artifacts when storing them.

1. Make redundant copies of your backup and store them in multiple locations. This minimizes the
risk of losing your backups in the event of a disaster.

1. Each time you redeploy <%= vars.product_short %>, test your backup artifact by following the procedures in:
  * [Restoring the <%- vars.product_short %> BOSH Director](bbr-restore-director.html).
  * [Restoring the <%- vars.product_short %> Control Plane](bbr-restore-control-plane.html).
  * [Restoring a Cluster](bbr-restore-cluster.html).
