---
title: Installing and Configuring PKS with NSX-T Integration
owner: PKS
---

<p class="note"><strong>Note</strong>: The PKS documentation is under development. This topic will continue to be updated and expanded to reflect the most current information.</p>

This topic describes how to install and configure Pivotal Container Service (PKS) on vSphere with NSX-T integration.

Before performing the procedures in this topic, consult the requirements in the [PKS With NSX-T Integration](requirements.html#pks-with-nsx-t) section of <em>Prerequisites and Resource Requirements</em>.

##<a id='deploy-nsx-t'></a> Step 1: Deploy NSX-T

Refer to the [NSX-T documentation](https://docs.vmware.com/en/VMware-NSX-T/index.html) in order to deploy the following core NSX-T components:

1. Deploy the NSX-T Manager.
1. Deploy the NSX-T Controller(s).
1. Join the NSX-T Control Cluster to the NSX-T Manger and initialize it.
1. Add your ESX host(s) to the NSX-T fabric.

##<a id='config-network'></a> Step 2: Configure Network Requirements for NSX-T Management Access

Refer to the [NSX-T documentation](https://docs.vmware.com/en/VMware-NSX-T/index.html) in order to provide or configure your network topology to enable the following:

* IPV4 Address Space
  * When Using a Fully Routed Topology For Your Kubernetes Clusters, various Network CIDRs will be required that should be accessible in your environment:
     * **VTEP CIDR(s)**: This will be the network(s) that will host your GENEVE Tunnel Endpoints.  It should be sized to support all of your expected Host and Edge Transport Nodes.
     * **PKS SERVICES CIDR**: This will be the network that will provide your Kubernetes address space, it should be /22 or larger depending on the number of clusters you will deploy.
     * **PKS LB CIDR**: This will be the network that will provide your load balancing address space.  A smaller /24 cidr is suggested here

* vCenter, NSX-T components, and ESXi hosts must be able to communicate with each other.
* The Ops Manager Director VM must be able to communicate with vCenter and the NSX-T Manager.
* The Ops Manager Director VM must be able to communicate with all nodes in all Kubernetes clusters.
* Each Kubernetes cluster deployed by PKS will deploy a NSX-T Container Plug-in (NCP) pod that must be able to communicate with the NSX-T Manager.

##<a id='create-objects'></a> Step 3: Create Required NSX-T Objects for PKS

Refer to the following [NSX-T documentation](https://docs.vmware.com/en/VMware-NSX-T/index.html) topics in order to create the objects in the NSX-T deployment required for PKS. 

<p class="note"><strong>Note</strong>: The procedures below can be used to deploy a fully routable network topology for an NSX-T deployment that supports PKS, but other topologies such as NAT are configurable.</p> 

1. [Create](https://docs.vmware.com/en/VMware-NSX-T/2.0/com.vmware.nsxt.install.doc/GUID-E7F7322D-D09B-481A-BD56-F1270D7C9692.html) two NSX IP Pools
  * One NSX IP pool for GENEVE Tunnel Endpoints `ip-pool-vteps`.
     * Use the appropriate **VTEP CIDR** and usable range
  * One NSX IP pool for NSX Load Balancing VIPs `ip-pool-vips`.
     * Use the appropriate **PKS LB CIDR** and usable range
1. [Create](https://docs.vmware.com/en/VMware-NSX-T/2.0/com.vmware.nsxt.install.doc/GUID-F739DC79-4358-49F4-9C58-812475F33A66.html) two NSX Transport Zones (TZs):
  * One NSX TZ for PKS Control Plane Services & Kubernetes Cluster deployment overlay network(s) `tz-overlay` and the associated Host Switch `hs-overlay`
  * One NSX TZ for NSX Edge uplink (ingress/egress) for PKS Kubernetes cluster(s) `tz-vlan`and the associated Host Switch `hs-vlan`

1. [Create](https://docs.vmware.com/en/VMware-NSX-T/2.0/com.vmware.nsxt.install.doc/GUID-50FDFDFB-F660-4269-9503-39AE2BBA95B4.html) a NSX Uplink Host Profile
<p class="note"><strong>Note</strong>: This task is optional if the default uplink profile is not applicable in your use case.</p> 

1. [Create](https://docs.vmware.com/en/VMware-NSX-T/2.0/com.vmware.nsxt.install.doc/GUID-D7CA778B-6554-4A23-879D-4BC336E01031.html) NSX Host Transport Node(s) 
  * For each host in Fabric `tnode-host-#`.
  * Add the `tz-overlay` NSX Transport Zone to each NSX Host Transport Node.
  <p class="note"><strong>Note</strong>: The transport nodes must be placed on free host NICs and must use an IP Pool (`ip-pool-vteps`) that will allow them to route and communicate with other transport nodes to build GENEVE tunnels.</p>

1. [Create](https://docs.vmware.com/en/VMware-NSX-T/2.0/com.vmware.nsxt.admin.doc/GUID-46C7B20D-4BE4-400E-AF39-1ADFE945DE38.html) a NSX IP Block `ip-block-pks-deployments`
  * IP Block will be used for NSX NCP & PKS to assign address space to Kubernetes Pods via (CNI).
  * Use the **PKS SERVICES CIDR**.

1. [Create](https://docs.vmware.com/en/VMware-NSX-T/2.0/com.vmware.nsxt.admin.doc/GUID-23194F9A-416A-40EA-B9F7-346B391C3EF8.html) the following NSX Logical Switches:
  * One for the PKS Service Network `ls-pks-service` 
     * Attach to the `tz-overlay` NSX Transport Zone
  * One for T0 ingress/egress uplink port `ls-pks-uplink`
     * Attach to the `tz-vlan` NSX Transport Zone 

1. [Deploy](https://docs.vmware.com/en/VMware-NSX-T/2.0/com.vmware.nsxt.install.doc/GUID-11417AA2-5EBC-49C7-8A86-EB94604261A6.html) NSX Edge VMs(s).
  * Connect the **first** Edge interface to your environment's PortGroup/VLAN where your Edge Management IP can route and communicate with the NSX-T Manager.
  * Connect the **second** Edge interface to your environment's PortGroup/VLAN where your T0 uplink interface will be located.
  * Connect the **third** Edge interface to your environment's PortGroup/VLAN where your GENEVE VTEPs can route and communicate with each other.

1. [Join](https://docs.vmware.com/en/VMware-NSX-T/2.0/com.vmware.nsxt.install.doc/GUID-11BB4CF9-BC1D-4A76-A32A-AD4C98CBF25B.html) the NSX Edge VM(s) to the NSX-T Fabric.

1. [Create](https://docs.vmware.com/en/VMware-NSX-T/2.0/com.vmware.nsxt.install.doc/GUID-50FDFDFB-F660-4269-9503-39AE2BBA95B4.html) a NSX Edge Uplink Profile
   * if the default profile is not applicable in your use case.
<p class="note"><strong>Note</strong>: This task is optional if the default uplink profile is not applicable in your use case.</p>
 
1. [Create](https://docs.vmware.com/en/VMware-NSX-T/2.0/com.vmware.nsxt.install.doc/GUID-53295329-F02F-44D7-A6E0-2E3A9FAE6CF9.html) NSX Edge Transport Node(s).
  * Add both `tz-vlan` and `tz-overlay` NSX Transport Zones to the NSX Edge transport node(s).
  * Refer to the mac adress of the Edge VM interfaces you deployed in a previous step to deploy your virtual NSX Edge(s):
     * Connect the `hs-vlan` host switch to Virtual nic (fp-eth#) that matches the mac address of the second nic from your deployed edge.
     * Connect the `hs-overlay` host swicth to Virtual nic (fp-eth#) that matches the mac address of the third nic from your deployed edge. 

1. [Create](https://docs.vmware.com/en/VMware-NSX-T/2.0/com.vmware.nsxt.install.doc/GUID-898099FC-4ED2-4553-809D-B81B494B67E7.html) an NSX Edge Cluster `edge-cluster-pks`.
  * Add the NSX Edge Transport Node(s) to the cluster.

1. [Create](https://docs.vmware.com/en/VMware-NSX-T/2.0/com.vmware.nsxt.admin.doc/GUID-7891E6E7-606D-4F79-8AB7-BC01898F9FE7.html) a tier-0 (T0) Logical Router `t0-pks`.
  * Attach as an uplink to the `ls-pks-uplink` logical switch you created in a previous step.
  * [Create](https://docs.vmware.com/en/VMware-NSX-T/2.0/com.vmware.nsxt.admin.doc/GUID-D641380B-4C8E-4C8A-AF64-4261A266ACA4.html) the logical router port for `ls-pks-uplink` and assign an IP address and CIDR that your environment will use to route to all PKS assigned IP Pools and IP Blocks.
  * [Configure](https://docs.vmware.com/en/VMware-NSX-T/2.0/com.vmware.nsxt.admin.doc/GUID-3F163DEE-1EE6-4D80-BEBF-8D109FDB577C.html) T0 routing to the rest of your environment using the appropriate routing protocal for your environment or by using static routes. 
  		*  The CIDR used in `ip-pool-vips` must route to this IP
  		*  The CIDR used in `ip-block-pks-deployments` must route to this IP


  
##<a id='config-ops-man'></a> Step 4: Configure Ops Manager

Perform the following steps to configure Ops Manager for the NSX logical switch:

1. Navigate to `YOUR-OPSMAN-FQDN` in a browser to log in to the Ops Manager Installation Dashboard.
1. Click the **Ops Manager Director** tile.
1. Click **Create Networks**.
1. Create the following two networks:
  * A network for deploying the PKS control plane VM(s)
  * A service network for deploying PKS Kubernetes cluster nodes, which should map to the NSX logical switch `ls-pks-service` created for the PKS Service Network in [Step 3: Create Required Objects](#create-objects)
1. Return to the Ops Manager Installation Dashboard and click **Apply Changes**.

##<a id='install'></a> Step 5: Install and Configure PKS

Perform the following steps to install and configure PKS:

1. Perform the procedure in [Step 1: Install PKS](installing.html#install) of <em>Installing and Configuring PKS</em> to install the PKS tile.
1. Click the orange **Pivotal Container Service** tile to start the configuration process.
    <p class="note"><strong>Note</strong>: Configuration of NSX-T or Flannel <strong>cannot</strong> be changed after installing PKS.</p>

###<a id='azs-networks'></a> Assign AZs and Networks

Perform the following steps:

1. Click **Assign AZs and Networks**.
1. Select an availability zone for your singleton jobs, and one or more availability zones to balance other jobs in. This is where PCF creates the PKS broker.
1. Under **Network**, select a **Singleton Availability Zone** network. This will provide network placement for the PKS broker. 
1. Under **Service Network**, select the **Service Network** linked to the `ls-pks-service` NSX logical switch you created in [Step 4: Configure Ops Manager](#config-ops-man). This will provide network placement for the on-demand service instances created by the PKS broker.
1. Click **Save**.

###<a id='pks-api'></a> PKS API

Perform the procedure in [PKS API](installing.html#pks-api) of <em>Installing and Configuring PKS</em>.

###<a id='broker'></a> Broker

Perform the procedure in [Broker](installing.html#broker) of <em>Installing and Configuring PKS</em>.

###<a id='plan'></a> Plan

Perform the procedures in [Plan](installing.html#plan) of <em>Installing and Configuring PKS</em>.

###<a id='iaas'></a> IaaS

Perform the procedures in [IaaS](installing.html#iaas) of <em>Installing and Configuring PKS</em>.

###<a id='networking'></a> Networking

Perform the following steps:

1. Click **Networking**.
1. Under **Network**, select **NSX-T** as the Container Network Type to use.
1. For **NSX Manager hostname**, enter the NSX Manager hostname or IP address.
1. For **NSX Manager credentials**, enter the credentials to connect to the NSX Manager.
1. For **NSX Manager CA Cert**, optionally enter the custom CA certificate to be used to connect to the NSX Manager.
1. The **Disable SSL certificate verification?** checkbox is **not** selected by default. In order to disable TLS verification, select the checkbox. You may want to disable TLS verification if you did not enter a CA certificate, or if your CA certificate is self-signed.
1. For **Tier 0 Router ID**, enter the `t0-pks` T0 router ID. This can be located in the NSX-T UI router overview.
1. For **IP Block ID**, enter the `ip-block-pks-deployments` IP block ID. This can also be located in the NSX-T UI.
1. For **Floating IP pool ID**, enter the `ip-pool-vips` Floating IP pool ID that was created for Load Balancer VIPs.
1. Click **Save**.

###<a id='errands'></a> Errands

Perform the following steps:

1. Click **Errands**.
1. For **Post Deploy Errands**, select **Default (On)** for the **NSX-T Validation errand**. This errand will validate your NSX-T configuration and will tag the proper resources.
1. Click **Save**.

###<a id='resources'></a> (Optional) Resource Config and Stemcell

To modify the resource usage or stemcell configuration of PKS, see [(Optional) Resource Config](installing.html#resource-config) and [(Optional) Stemcell](installing.html#stemcell) in <em>Installing and Configuring PKS</em>.

##<a id='apply-changes'></a> Step 6: Apply Changes

After configuring the tile, return to the Ops Manager Installation Dashboard and click **Apply Changes** to deploy the tile.

Finish your PKS installation by performing the procedures in [Step 5: Retrieve PKS Endpoint](installing.html#retrieve-pks-api) and [Step 6: Configure External Load Balancer](installing.html#loadbalancer-pks-api) of <em>Installing and Configuring PKS</em>.


